{% extends "./base.html" %}
{% block title %}
Add-Manager
{% endblock title %}

{% block content %}
{% block extra-stylesheets %} 
<style type="text/css">
	.image-container{
		max-width: 250px;
		height: auto;
		position: relative;
	}
	.field-heading{
		color: #737373;
	}
	#id_confirm{
		color: #33ff33;
	}
	#id_confirm:hover {
		opacity: 0.5;
	}
	#id_cancel:hover {
		opacity: 0.5;
	}
	#id_cancel{
		color: red;
	}
	.material-icons{
		font-size: 30px;
	}
	.material-icons:hover{
		cursor: pointer;
	}
</style>
{% endblock extra-stylesheets %} 

<body class="">
    <main class="main-content  mt-0">
        <section class="min-vh-100 mb-8">
            <div class="page-header align-items-start min-vh-75 pt-5 pb-11 m-3 border-radius-lg"
                style="background-image: url('/static/assets/img/curved-images/pencil.jpg');">
                <span class="mask bg-gradient-dark opacity-6"></span>
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-5 text-center mx-auto">
                            <h1 class="text-white mb-2 mt-5">Welcome!</h1>
                            <p class="text-lead text-white">Please enter your following details</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row mt-lg-n50 mt-md-n12 mt-n50">
                    <div class="col-xl-4 col-lg-5 col-md-7 mx-auto">
                        <div class="card z-index-0">
                            <div class="card-header text-center pt-4">
                                <h5>Add Manager</h5>
                            </div>
                            
                            <div class="tab-menu-heading">
                                {% if form.errors %}
                                {% for field in form %}
                                {% for error in field.errors %}
                                <div class="alert alert-danger" role="alert">
                                    <strong>{{ error|escape }}</strong>
                                </div>
                                {% endfor %}
                                {% endfor %}
                                {% else %}
                                {% block error_messages %}
                                {% if messages %}
                                {% for message in messages %}
                                <div class="alert alert-{{ message.tags }}" role="alert">
                                    <p>{{ message }}</p>
                                </div>
                                {% endfor %}
                                {% endif %}
                                {% endblock error_messages %}
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <form role="form text-left" action="{% url 'core:add-manager' %}" method="post">
                                    {% csrf_token %}
                                    <label>Profile Picture</label>
                                    <!-- <div class="d-flex flex-column justify-content-center">
                                        <div class="image-container mx-auto mb-4">
                                            <img src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img (31).webp" class="account-image rounded-circle m-auto d-block dropdown-toggle" style="cursor: pointer;" id="id_profile_links" data-bs-toggle="dropdown" aria-expanded="false" width="150" height="150">
                                        </div>
                                    </div> -->
                                    <div class="container-fluid p-t-20">
                                        <div class="d-flex flex-row justify-content-center flex-wrap align-items-start">
                                            
                                            <div class="card profile-card">
                                              <div class="card-body flex-row">
                                    
                                                  <div class="d-flex flex-column justify-content-center p-4">
                                                      
                                                    <div class="container" id="id_loading_spinner" style="display: none">
                                                        <div class="d-flex flex-row mx-auto flex-grow-1 justify-content-center">
                                                          <div class="spinner-border text-primary" role="status">
                                                            <span class="sr-only"></span>
                                                          </div>
                                                        </div>
                                                    </div>
													<!-- <div class="mb-2" id="id_image_crop_confirm">
														<span id="id_cancel" class="material-icons">cancel</span>
														<span id="id_confirm" class="material-icons">check</span>
													</div> -->
													
                                                    <div class="image-container" id="id_image_container">
                                                        <img class="border border-dark rounded-circle img-fluid mx-auto profile-image" id="id_profile_image_display" src="{{request.user.profile_pic.url}}" alt="Profile" >
                                                        <div class="middle" id="id_middle_container">
                                                            <div class="material-icons" id="id_text">add_circle</div>
														
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                    
                                                <div class="d-flex flex-column justify-content-center">
                                                      
                                                    <form class="form-signin" method="post" enctype="multipart/form-data">{% csrf_token %}
                                                          <input class="d-none" type="file" name="profile_image" id="id_profile_image" onchange="readURL(this)">                                                        
                                                    </form>
                                    
                                                  </div>
                                    
                                              </div>
                                            </div>
                                        </div>
                                    </div>

                                    <label>First Name</label>
                                    <div class="mb-3">
                                        {{ form.first_name }}
                                    </div>
                                    <label>Last Name</label>
                                    <div class="mb-3">
                                        {{ form.last_name }}
                                    </div>
                                    <label>User Name</label>
                                    <div class="mb-3">
                                        {{ form.username }}
                                    </div>
                                    <label>Email</label>
                                    <div class="mb-3">
                                        {{ form.email }}
                                    </div>
                                    <label>Password</label>
                                    <div class="mb-3">
                                        {{ form.password }}
                                    </div>
                                   
                                    <div class="text-center">
                                        <input type="submit" class="btn bg-gradient-info w-100 mt-4 mb-0"
                                            value="Add Manager" />
                                    </div>
                                    
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</body>

<script type="text/javascript">

	var cropper;
	var imageFile;
	var base64ImageString;
	var cropX;
	var cropX;
	var cropWidth;
	var cropHeight;

	enableImageOverlay()

	function enableImageOverlay(){
		var text = document.getElementById("id_text")
		//text.style.backgroundColor = "#0066ff"
		text.style.color = "#0066ff"
		text.style.fontSize = "0px"
		//text.style.padding = "16px 32px"
		text.style.cursor = "pointer"

		var profileImage = document.getElementById("id_profile_image")
		profileImage.style.opacity = "1"
		profileImage.style.display = "block"
		profileImage.style.width = "100%"
		profileImage.style.height = "auto"
		profileImage.style.transition = ".5s ease"
		profileImage.style.backfaceVisibility  = "hidden"
		profileImage.style.cursor = "pointer"

		var middleContainer = document.getElementById("id_middle_container")
		middleContainer.style.transition = ".5s ease"
		middleContainer.style.opacity = "0"
		middleContainer.style.position = "absolute"
		middleContainer.style.top = "50%"
		middleContainer.style.left = "50%"
		middleContainer.style.transform = "translate(-50%, -50%)"
		middleContainer.style.textAlign = "center"

		var imageContainer = document.getElementById("id_image_container")
		imageContainer.addEventListener("mouseover", function( event ) { 
			profileImage.style.opacity = "0.3"
			middleContainer.style.opacity = "1"
		})

		imageContainer.addEventListener("mouseout", function( event ) { 
			profileImage.style.opacity = "1"
			middleContainer.style.opacity = "0"
		})

		imageContainer.addEventListener("click", function(event){
			document.getElementById('id_profile_image').click();
		});

		var cropConfirm = document.getElementById("id_image_crop_confirm")
		cropConfirm.classList.remove("d-flex")
		cropConfirm.classList.remove("flex-row")
		cropConfirm.classList.remove("justify-content-between")
		cropConfirm.classList.add("d-none")
		
	}

	function disableImageOverlay(){
		var profileImage = document.getElementById("id_profile_image_display")
		var middleContainer = document.getElementById("id_middle_container")
		var imageContainer = document.getElementById("id_image_container")
		var text = document.getElementById("id_text")

		imageContainer.removeEventListener("mouseover", function( event ) { 
			profileImage.style.opacity = "0.3"
			middleContainer.style.opacity = "1"
		})

		imageContainer.removeEventListener("mouseout", function( event ) { 
			profileImage.style.opacity = "1"
			middleContainer.style.opacity = "0"
		})

		profileImage.style.opacity = "1"
		middleContainer.style.opacity = "0"
		text.style.cursor = "move"
		text.style.opacity = "0"

		document.getElementById('id_image_container').removeEventListener("click", function(event){
			event.preventDefault();
			// do nothing
		});
		document.getElementById('id_profile_image').addEventListener("click", function(event){
			event.preventDefault();
			// do nothing
		});

		var cropConfirm = document.getElementById("id_image_crop_confirm")
		cropConfirm.classList.remove("d-none")
		cropConfirm.classList.add("d-flex")
		cropConfirm.classList.add("flex-row")
		cropConfirm.classList.add("justify-content-between")

		var confirm = document.getElementById("id_confirm")
		confirm.addEventListener("click", function(event){
			console.log("Sending crop data for processing...")
			cropImage(
				imageFile, 
				cropX, 
				cropY, 
				cropWidth,
				cropHeight
			)
		})

		var cancel = document.getElementById("id_cancel")
		cancel.addEventListener("click", function(event){
			console.log("Reloading window...")
			window.location.reload();
		})
	}

	/ return null if invalid or base64String if valid /
	function isImageSizeValid(image){
		console.log("max size: {{DATA_UPLOAD_MAX_MEMORY_SIZE}}")
		var startIndex = image.indexOf("base64,") + 7;
		var base64str = image.substr(startIndex);
		var decoded = atob(base64str);
		console.log("FileSize: " + decoded.length);
		/*
		if(decoded.length>= "{{DATA_UPLOAD_MAX_MEMORY_SIZE}}"){
			console.log("image size exceed")
			return null
		} */
		return base64str
	}

	function cropImage(image, x, y, width, height){
		base64ImageString = isImageSizeValid(image)

		if(base64ImageString != null){
			var requestData = {
				"csrfmiddlewaretoken": "{{ csrf_token }}",
				"image": base64ImageString,
				"cropX": cropX,
				"cropY": cropY,
				"cropWidth": cropWidth,
				"cropHeight": cropHeight
			}
			displayLoadingSpinner(true)
			$.ajax({
				type: 'POST',
				dataType: "json",
				url: "{% url 'core:cropimage'%}",
				data: requestData,
				timeout: 10000,
				success: function(data) {
					if(data.result == "success"){
						document.getElementById("id_cancel").click()
					}
					else if(data.result == "error"){
						alert(data.exception)
						document.getElementById("id_cancel").click()
					}
				},
				error: function(data) {
					console.error("ERROR...", data)
				},
				complete: function(data){
					displayLoadingSpinner(false)
				}
			});
		}
		else{
			alert("Upload an image smaller than 10 MB");
			document.getElementById("id_cancel").click()
		}
	}

	/*
		Called when a new image is selected from file chooser dialog
	*/
	function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
            	disableImageOverlay()
				console.log("readURL")
            	var image = e.target.result
            	var imageField = document.getElementById('id_profile_image_display')
                imageField.src = image
				cropper = new Cropper(imageField, {
					aspectRatio: 1/1,
					crop(event) {
						//console.log("CROP START")
						//console.log("x: " + event.detail.x);
						//console.log("y: " + event.detail.y);
						//console.log("width: " + event.detail.width);
						//console.log("height: " + event.detail.height);
						setImageCropProperties(
							image,
							event.detail.x,
							event.detail.y,
							event.detail.width,
							event.detail.height
						)
					},
				});
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    function setImageCropProperties(image, x, y, width, height){
		imageFile = image
		cropX = x
		cropY = y
		cropWidth = width
		cropHeight = height
	}

	function displayLoadingSpinner(isDisplayed){
		var spinner = document.getElementById("id_loading_spinner")
		if(isDisplayed){
			spinner.style.display = "block"
		}
		else{
			spinner.style.display = "none"
		}
	}

</script>
    {% endblock content %}